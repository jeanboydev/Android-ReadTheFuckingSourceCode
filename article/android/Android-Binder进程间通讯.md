# Android - Binder è¿›ç¨‹é—´é€šè®¯

## æ¦‚è¿°

æœ€è¿‘åœ¨å­¦ä¹  Binder æœºåˆ¶ï¼Œåœ¨ç½‘ä¸ŠæŸ¥é˜…äº†å¤§é‡çš„èµ„æ–™ï¼Œä¹Ÿçœ‹äº†è€ç½—çš„ Binder ç³»åˆ—çš„åšå®¢å’Œ Innost çš„æ·±å…¥ç†è§£ Binder ç³»åˆ—çš„åšå®¢ï¼Œéƒ½æ˜¯ä»åº•å±‚å¼€å§‹è®²çš„ï¼Œå…¨æ˜¯ C ä»£ç ï¼Œè™½ç„¶ä¹‹å‰å­¦è¿‡ C å’Œ C++ï¼Œç„¶è€Œå„ç§å‡½æ•°ä¹‹é—´èŠ±å¼è·³è½¬ï¼Œçœ‹çš„æˆ‘éƒ½æ€€ç–‘äººç”Ÿã€‚ æ¯«ä¸å¤¸å¼ çš„è®²æ¯çœ‹ä¸€ééƒ½æ˜¯æ–°çš„å†…å®¹ï¼Œè·Ÿæ²¡çœ‹è¿‡ä¸€æ ·ã€‚ åæ¥åˆçœ‹åˆ°äº† Gityuan çš„åšå®¢çœ‹åˆ°äº†ä¸€äº›å›¾è§£ä»¿ä½›å‘ç°äº†æ–°å¤§é™†ã€‚ 

ä¸‹é¢å°±ä»¥å›¾è§£çš„æ–¹å¼ä»‹ç»ä¸‹ Binder æœºåˆ¶ï¼Œç›¸ä¿¡ä½ çœ‹è¿™ç¯‡æ–‡ç« ï¼Œä¸€å®šæœ‰æ‰€æ”¶è·ã€‚


## ä»€ä¹ˆæ˜¯ Binderï¼Ÿ

Binder æ˜¯ Android ç³»ç»Ÿä¸­è¿›ç¨‹é—´é€šè®¯ï¼ˆIPCï¼‰çš„ä¸€ç§æ–¹å¼ï¼Œä¹Ÿæ˜¯ Android ç³»ç»Ÿä¸­æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ã€‚ Android ä¸­çš„å››å¤§ç»„ä»¶ Activityï¼ŒServiceï¼ŒBroadcastï¼ŒContentProviderï¼Œä¸åŒçš„ App ç­‰éƒ½è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œå®ƒæ˜¯è¿™äº›è¿›ç¨‹é—´é€šè®¯çš„æ¡¥æ¢ã€‚æ­£å¦‚å…¶åâ€œç²˜åˆå‰‚â€ä¸€æ ·ï¼Œå®ƒæŠŠç³»ç»Ÿä¸­å„ä¸ªç»„ä»¶ç²˜åˆåˆ°äº†ä¸€èµ·ï¼Œæ˜¯å„ä¸ªç»„ä»¶çš„æ¡¥æ¢ã€‚

ç†è§£ Binder å¯¹äºç†è§£æ•´ä¸ª Android ç³»ç»Ÿæœ‰ç€éå¸¸é‡è¦çš„ä½œç”¨ï¼Œå¦‚æœå¯¹ Binder ä¸äº†è§£ï¼Œå°±å¾ˆéš¾å¯¹ Android ç³»ç»Ÿæœºåˆ¶æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚


## 1. Binder æ¶æ„

![å›¾1][1]

- Binder é€šä¿¡é‡‡ç”¨ C/S æ¶æ„ï¼Œä»ç»„ä»¶è§†è§’æ¥è¯´ï¼ŒåŒ…å« Clientã€ Serverã€ ServiceManager ä»¥åŠ Binder é©±åŠ¨ï¼Œå…¶ä¸­ ServiceManager ç”¨äºç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚
- Binder åœ¨ framework å±‚è¿›è¡Œäº†å°è£…ï¼Œé€šè¿‡ JNI æŠ€æœ¯è°ƒç”¨ Nativeï¼ˆC/C++ï¼‰å±‚çš„ Binder æ¶æ„ã€‚ 
- Binder åœ¨ Native å±‚ä»¥ ioctl çš„æ–¹å¼ä¸ Binder é©±åŠ¨é€šè®¯ã€‚

## 2. Binder æœºåˆ¶

![å›¾8][8]

- é¦–å…ˆéœ€è¦æ³¨å†ŒæœåŠ¡ç«¯ï¼Œåªæœ‰æ³¨å†Œäº†æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯æ‰æœ‰é€šè®¯çš„ç›®æ ‡ï¼ŒæœåŠ¡ç«¯é€šè¿‡ ServiceManager æ³¨å†ŒæœåŠ¡ï¼Œæ³¨å†Œçš„è¿‡ç¨‹å°±æ˜¯å‘ Binder é©±åŠ¨çš„å…¨å±€é“¾è¡¨ binder_procs ä¸­æ’å…¥æœåŠ¡ç«¯çš„ä¿¡æ¯ï¼ˆbinder_proc ç»“æ„ä½“ï¼Œæ¯ä¸ª binder_proc ç»“æ„ä½“ä¸­éƒ½æœ‰ todo ä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼Œç„¶åå‘ ServiceManager çš„ svcinfo åˆ—è¡¨ä¸­ç¼“å­˜ä¸€ä¸‹æ³¨å†Œçš„æœåŠ¡ã€‚

- æœ‰äº†æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è·ŸæœåŠ¡ç«¯é€šè®¯äº†ï¼Œé€šè®¯ä¹‹å‰éœ€è¦å…ˆè·å–åˆ°æœåŠ¡ï¼Œæ‹¿åˆ°æœåŠ¡çš„ä»£ç†ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå¼•ç”¨ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š
	```Java
	//è·å–WindowManageræœåŠ¡å¼•ç”¨
	WindowManager wm = (WindowManager)getSystemService(getApplication().WINDOW_SERVICE);
	```
	è·å–æœåŠ¡ç«¯çš„æ–¹å¼å°±æ˜¯é€šè¿‡ ServiceManager å‘ svcinfo åˆ—è¡¨ä¸­æŸ¥è¯¢ä¸€ä¸‹è¿”å›æœåŠ¡ç«¯çš„ä»£ç†ï¼Œsvcinfo åˆ—è¡¨å°±æ˜¯æ‰€æœ‰å·²æ³¨å†ŒæœåŠ¡çš„é€šè®¯å½•ï¼Œä¿å­˜äº†æ‰€æœ‰æ³¨å†Œçš„æœåŠ¡ä¿¡æ¯ã€‚

- æœ‰äº†æœåŠ¡ç«¯çš„å¼•ç”¨æˆ‘ä»¬å°±å¯ä»¥å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚äº†ï¼Œé€šè¿‡ BinderProxy å°†æˆ‘ä»¬çš„è¯·æ±‚å‚æ•°å‘é€ç»™ ServiceManagerï¼Œé€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼ä½¿ç”¨å†…æ ¸æ–¹æ³• copy_from_user() å°†æˆ‘ä»¬çš„å‚æ•°å…ˆæ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œè¿™æ—¶æˆ‘ä»¬çš„å®¢æˆ·ç«¯è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç„¶å Binder é©±åŠ¨å‘æœåŠ¡ç«¯çš„ todo é˜Ÿåˆ—é‡Œé¢æ’å…¥ä¸€æ¡äº‹åŠ¡ï¼Œæ‰§è¡Œå®Œä¹‹åæŠŠæ‰§è¡Œç»“æœé€šè¿‡ copy_to_user() å°†å†…æ ¸çš„ç»“æœæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆè¿™é‡Œåªæ˜¯æ‰§è¡Œäº†æ‹·è´å‘½ä»¤ï¼Œå¹¶æ²¡æœ‰æ‹·è´æ•°æ®ï¼Œbinderåªè¿›è¡Œä¸€æ¬¡æ‹·è´ï¼‰ï¼Œå”¤é†’ç­‰å¾…çš„å®¢æˆ·ç«¯å¹¶æŠŠç»“æœå“åº”å›æ¥ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€æ¬¡é€šè®¯ã€‚

æ€ä¹ˆæ ·æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œä»¥ä¸Šå°±æ˜¯ Binder æœºåˆ¶çš„ä¸»è¦é€šè®¯æ–¹å¼ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“å®ç°ã€‚


## 3. Binder é©±åŠ¨

æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´æ˜¯æ€ä¹ˆäº¤äº’çš„ã€‚

![å›¾2][2]

å…ˆäº†è§£ä¸€äº›æ¦‚å¿µ

### ç”¨æˆ·ç©ºé—´/å†…æ ¸ç©ºé—´

è¯¦ç»†è§£é‡Šå¯ä»¥å‚è€ƒ [Kernel Space Definition](http://www.linfo.org/kernel_space.html)ï¼› ç®€å•ç†è§£å¦‚ä¸‹ï¼š

Kernel space æ˜¯ Linux å†…æ ¸çš„è¿è¡Œç©ºé—´ï¼ŒUser space æ˜¯ç”¨æˆ·ç¨‹åºçš„è¿è¡Œç©ºé—´ã€‚ ä¸ºäº†å®‰å…¨ï¼Œå®ƒä»¬æ˜¯éš”ç¦»çš„ï¼Œå³ä½¿ç”¨æˆ·çš„ç¨‹åºå´©æºƒäº†ï¼Œå†…æ ¸ä¹Ÿä¸å—å½±å“ã€‚

Kernel space å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè°ƒç”¨ç³»ç»Ÿçš„ä¸€åˆ‡èµ„æºï¼› User space åªèƒ½æ‰§è¡Œç®€å•çš„è¿ç®—ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œå¿…é¡»é€šè¿‡ç³»ç»Ÿæ¥å£ï¼ˆåˆç§° system callï¼‰ï¼Œæ‰èƒ½å‘å†…æ ¸å‘å‡ºæŒ‡ä»¤ã€‚

### ç³»ç»Ÿè°ƒç”¨/å†…æ ¸æ€/ç”¨æˆ·æ€

è™½ç„¶ä»é€»è¾‘ä¸ŠæŠ½ç¦»å‡ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ï¼›ä½†æ˜¯ä¸å¯é¿å…çš„çš„æ˜¯ï¼Œæ€»æœ‰é‚£ä¹ˆä¸€äº›ç”¨æˆ·ç©ºé—´éœ€è¦è®¿é—®å†…æ ¸çš„èµ„æºï¼›æ¯”å¦‚åº”ç”¨ç¨‹åºè®¿é—®æ–‡ä»¶ï¼Œç½‘ç»œæ˜¯å¾ˆå¸¸è§çš„äº‹æƒ…ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ

> Kernel space can be accessed by user processes only through the use of system calls.

ç”¨æˆ·ç©ºé—´è®¿é—®å†…æ ¸ç©ºé—´çš„å”¯ä¸€æ–¹å¼å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼›é€šè¿‡è¿™ä¸ªç»Ÿä¸€å…¥å£æ¥å£ï¼Œæ‰€æœ‰çš„èµ„æºè®¿é—®éƒ½æ˜¯åœ¨å†…æ ¸çš„æ§åˆ¶ä¸‹æ‰§è¡Œï¼Œä»¥å…å¯¼è‡´å¯¹ç”¨æˆ·ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„è¶Šæƒè®¿é—®ï¼Œä»è€Œä¿éšœäº†ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®šã€‚ç”¨æˆ·è½¯ä»¶è‰¯è ä¸é½ï¼Œè¦æ˜¯å®ƒä»¬ä¹±ææŠŠç³»ç»Ÿç©åäº†æ€ä¹ˆåŠï¼Ÿå› æ­¤å¯¹äºæŸäº›ç‰¹æƒæ“ä½œå¿…é¡»äº¤ç»™å®‰å…¨å¯é çš„å†…æ ¸æ¥æ‰§è¡Œã€‚

å½“ä¸€ä¸ªä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è€Œé™·å…¥å†…æ ¸ä»£ç ä¸­æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬å°±ç§°è¿›ç¨‹å¤„äºå†…æ ¸è¿è¡Œæ€ï¼ˆæˆ–ç®€ç§°ä¸ºå†…æ ¸æ€ï¼‰æ­¤æ—¶å¤„ç†å™¨å¤„äºç‰¹æƒçº§æœ€é«˜çš„ï¼ˆ0çº§ï¼‰å†…æ ¸ä»£ç ä¸­æ‰§è¡Œã€‚å½“è¿›ç¨‹åœ¨æ‰§è¡Œç”¨æˆ·è‡ªå·±çš„ä»£ç æ—¶ï¼Œåˆ™ç§°å…¶å¤„äºç”¨æˆ·è¿è¡Œæ€ï¼ˆç”¨æˆ·æ€ï¼‰ã€‚å³æ­¤æ—¶å¤„ç†å™¨åœ¨ç‰¹æƒçº§æœ€ä½çš„ï¼ˆ3çº§ï¼‰ç”¨æˆ·ä»£ç ä¸­è¿è¡Œã€‚å¤„ç†å™¨åœ¨ç‰¹æƒç­‰çº§é«˜çš„æ—¶å€™æ‰èƒ½æ‰§è¡Œé‚£äº›ç‰¹æƒCPUæŒ‡ä»¤ã€‚

### å†…æ ¸æ¨¡å—/é©±åŠ¨

é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥è®¿é—®å†…æ ¸ç©ºé—´ï¼Œé‚£ä¹ˆå¦‚æœä¸€ä¸ªç”¨æˆ·ç©ºé—´æƒ³ä¸å¦å¤–ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›è¡Œé€šä¿¡æ€ä¹ˆåŠå‘¢ï¼Ÿå¾ˆè‡ªç„¶æƒ³åˆ°çš„æ˜¯è®©æ“ä½œç³»ç»Ÿå†…æ ¸æ·»åŠ æ”¯æŒï¼›ä¼ ç»Ÿçš„ Linux é€šä¿¡æœºåˆ¶ï¼Œæ¯”å¦‚ Socketï¼Œç®¡é“ç­‰éƒ½æ˜¯å†…æ ¸æ”¯æŒçš„ï¼›ä½†æ˜¯ Binder å¹¶ä¸æ˜¯ Linux å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯æ€ä¹ˆåšåˆ°è®¿é—®å†…æ ¸ç©ºé—´çš„å‘¢ï¼Ÿ Linux çš„åŠ¨æ€å¯åŠ è½½å†…æ ¸æ¨¡å—ï¼ˆLoadable Kernel Moduleï¼ŒLKMï¼‰æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼›æ¨¡å—æ˜¯å…·æœ‰ç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºï¼Œå®ƒå¯ä»¥è¢«å•ç‹¬ç¼–è¯‘ï¼Œä½†ä¸èƒ½ç‹¬ç«‹è¿è¡Œã€‚å®ƒåœ¨è¿è¡Œæ—¶è¢«é“¾æ¥åˆ°å†…æ ¸ä½œä¸ºå†…æ ¸çš„ä¸€éƒ¨åˆ†åœ¨å†…æ ¸ç©ºé—´è¿è¡Œã€‚è¿™æ ·ï¼ŒAndroidç³»ç»Ÿå¯ä»¥é€šè¿‡æ·»åŠ ä¸€ä¸ªå†…æ ¸æ¨¡å—è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·è¿›ç¨‹ä¹‹é—´çš„é€šè¿‡è¿™ä¸ªæ¨¡å—ä½œä¸ºæ¡¥æ¢ï¼Œå°±å¯ä»¥å®Œæˆé€šä¿¡äº†ã€‚

åœ¨ Android ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªè¿è¡Œåœ¨å†…æ ¸ç©ºé—´çš„ï¼Œè´Ÿè´£å„ä¸ªç”¨æˆ·è¿›ç¨‹é€šè¿‡ Binder é€šä¿¡çš„å†…æ ¸æ¨¡å—å«åš Binder é©±åŠ¨;

> é©±åŠ¨ç¨‹åºä¸€èˆ¬æŒ‡çš„æ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆDevice Driverï¼‰ï¼Œæ˜¯ä¸€ç§å¯ä»¥ä½¿è®¡ç®—æœºå’Œè®¾å¤‡é€šä¿¡çš„ç‰¹æ®Šç¨‹åºã€‚ç›¸å½“äºç¡¬ä»¶çš„æ¥å£ï¼Œæ“ä½œç³»ç»Ÿåªæœ‰é€šè¿‡è¿™ä¸ªæ¥å£ï¼Œæ‰èƒ½æ§åˆ¶ç¡¬ä»¶è®¾å¤‡çš„å·¥ä½œï¼›

é©±åŠ¨å°±æ˜¯æ“ä½œç¡¬ä»¶çš„æ¥å£ï¼Œä¸ºäº†æ”¯æŒ Binder é€šä¿¡è¿‡ç¨‹ï¼ŒBinder ä½¿ç”¨äº†ä¸€ç§â€œç¡¬ä»¶â€ï¼Œå› æ­¤è¿™ä¸ªæ¨¡å—è¢«ç§°ä¹‹ä¸ºé©±åŠ¨ã€‚


ç†Ÿæ‚‰äº†ä¸Šé¢è¿™äº›æ¦‚å¿µï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ä¸Šé¢çš„å›¾ï¼Œç”¨æˆ·ç©ºé—´ä¸­ binder_open(), binder_mmap(), binder_ioctl() è¿™äº›æ–¹æ³•é€šè¿‡ system call æ¥è°ƒç”¨å†…æ ¸ç©ºé—´ Binder é©±åŠ¨ä¸­çš„æ–¹æ³•ã€‚å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´å…±äº«å†…å­˜é€šè¿‡ copy_from_user(), copy_to_user() å†…æ ¸æ–¹æ³•æ¥å®Œæˆç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´å†…å­˜çš„æ•°æ®ä¼ è¾“ã€‚ Binderé©±åŠ¨ä¸­æœ‰ä¸€ä¸ªå…¨å±€çš„ binder_procs é“¾è¡¨ä¿å­˜äº†æœåŠ¡ç«¯çš„è¿›ç¨‹ä¿¡æ¯ã€‚

## 4. Binder è¿›ç¨‹ä¸çº¿ç¨‹

![å›¾3][3]

å¯¹äºåº•å±‚Binderé©±åŠ¨ï¼Œé€šè¿‡ binder_procs é“¾è¡¨è®°å½•æ‰€æœ‰åˆ›å»ºçš„ binder_proc ç»“æ„ä½“ï¼Œbinder é©±åŠ¨å±‚çš„æ¯ä¸€ä¸ª binder_proc ç»“æ„ä½“éƒ½ä¸ç”¨æˆ·ç©ºé—´çš„ä¸€ä¸ªç”¨äº binder é€šä¿¡çš„è¿›ç¨‹ä¸€ä¸€å¯¹åº”ï¼Œä¸”æ¯ä¸ªè¿›ç¨‹æœ‰ä¸”åªæœ‰ä¸€ä¸ª ProcessState å¯¹è±¡ï¼Œè¿™æ˜¯é€šè¿‡å•ä¾‹æ¨¡å¼æ¥ä¿è¯çš„ã€‚åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¾ˆå¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª IPCThreadState å¯¹è±¡ï¼ŒIPCThreadState å¯¹è±¡ä¹Ÿæ˜¯å•ä¾‹æ¨¡å¼ï¼Œå³ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª IPCThreadState å¯¹è±¡ï¼Œåœ¨ Binder é©±åŠ¨å±‚ä¹Ÿæœ‰ä¸ä¹‹ç›¸å¯¹åº”çš„ç»“æ„ï¼Œé‚£å°±æ˜¯ Binder_thread ç»“æ„ä½“ã€‚åœ¨ binder_proc ç»“æ„ä½“ä¸­é€šè¿‡æˆå‘˜å˜é‡ rb_root threadsï¼Œæ¥è®°å½•å½“å‰è¿›ç¨‹å†…æ‰€æœ‰çš„ binder_threadã€‚

Binder çº¿ç¨‹æ± ï¼šæ¯ä¸ª Server è¿›ç¨‹åœ¨å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ª binder çº¿ç¨‹æ± ï¼Œå¹¶å‘å…¶ä¸­æ³¨å†Œä¸€ä¸ª Binder çº¿ç¨‹ï¼›ä¹‹å Server è¿›ç¨‹ä¹Ÿå¯ä»¥å‘ binder çº¿ç¨‹æ± æ³¨å†Œæ–°çš„çº¿ç¨‹ï¼Œæˆ–è€… Binder é©±åŠ¨åœ¨æ¢æµ‹åˆ°æ²¡æœ‰ç©ºé—² binder çº¿ç¨‹æ—¶ä¸»åŠ¨å‘ Server è¿›ç¨‹æ³¨å†Œæ–°çš„çš„ binder çº¿ç¨‹ã€‚å¯¹äºä¸€ä¸ª Server è¿›ç¨‹æœ‰ä¸€ä¸ªæœ€å¤§ Binder çº¿ç¨‹æ•°é™åˆ¶ï¼Œé»˜è®¤ä¸º16ä¸ª binder çº¿ç¨‹ï¼Œä¾‹å¦‚ Android çš„ system_server è¿›ç¨‹å°±å­˜åœ¨16ä¸ªçº¿ç¨‹ã€‚å¯¹äºæ‰€æœ‰ Client ç«¯è¿›ç¨‹çš„ binder è¯·æ±‚éƒ½æ˜¯äº¤ç”± Server ç«¯è¿›ç¨‹çš„ binder çº¿ç¨‹æ¥å¤„ç†çš„ã€‚

## 5. ServiceManager å¯åŠ¨

äº†è§£äº† Binder é©±åŠ¨ï¼Œæ€ä¹ˆä¸ Binder é©±åŠ¨è¿›è¡Œé€šè®¯å‘¢ï¼Ÿé‚£å°±æ˜¯é€šè¿‡ ServiceManagerï¼Œå¥½å¤šæ–‡ç« ç§° ServiceManager æ˜¯ Binder é©±åŠ¨çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå¤§ç®¡å®¶ï¼Œå…¶å® ServiceManager çš„ä½œç”¨å¾ˆç®€å•å°±æ˜¯æä¾›äº†æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡çš„åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ServiceManager å¯åŠ¨çš„è¿‡ç¨‹ã€‚

![å›¾4][4]

- ServiceManager åˆ†ä¸º framework å±‚å’Œ native å±‚ï¼Œframework å±‚åªæ˜¯å¯¹ native å±‚è¿›è¡Œäº†å°è£…æ–¹ä¾¿è°ƒç”¨ï¼Œå›¾ä¸Šå±•ç¤ºçš„æ˜¯ native å±‚çš„ ServiceManager å¯åŠ¨è¿‡ç¨‹ã€‚

- ServiceManager çš„å¯åŠ¨æ˜¯ç³»ç»Ÿåœ¨å¼€æœºæ—¶ï¼Œinit è¿›ç¨‹è§£æ init.rc æ–‡ä»¶è°ƒç”¨ service_manager.c ä¸­çš„ main() æ–¹æ³•å…¥å£å¯åŠ¨çš„ã€‚ native å±‚æœ‰ä¸€ä¸ª binder.c å°è£…äº†ä¸€äº›ä¸ Binder é©±åŠ¨äº¤äº’çš„æ–¹æ³•ã€‚

- ServiceManager çš„å¯åŠ¨åˆ†ä¸ºä¸‰æ­¥ï¼Œé¦–å…ˆæ‰“å¼€é©±åŠ¨åˆ›å»ºå…¨å±€é“¾è¡¨ binder_procsï¼Œç„¶åå°†è‡ªå·±å½“å‰è¿›ç¨‹ä¿¡æ¯ä¿å­˜åˆ° binder_procs é“¾è¡¨ï¼Œæœ€åå¼€å¯ loop ä¸æ–­çš„å¤„ç†å…±äº«å†…å­˜ä¸­çš„æ•°æ®ï¼Œå¹¶å¤„ç† BR_xxx å‘½ä»¤ï¼ˆioctl çš„å‘½ä»¤ï¼ŒBR å¯ä»¥ç†è§£ä¸º binder reply é©±åŠ¨å¤„ç†å®Œçš„å“åº”ï¼‰ã€‚

## 6. ServiceManager æ³¨å†ŒæœåŠ¡

![å›¾5][5]

- æ³¨å†Œ MediaPlayerService æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬é€šè¿‡ ServiceManager çš„ addService() æ–¹æ³•æ¥æ³¨å†ŒæœåŠ¡ã€‚

- é¦–å…ˆ ServiceManager å‘ Binder é©±åŠ¨å‘é€ BC_TRANSACTION å‘½ä»¤ï¼ˆioctl çš„å‘½ä»¤ï¼ŒBC å¯ä»¥ç†è§£ä¸º binder client å®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚å‘½ä»¤ï¼‰æºå¸¦ ADD_SERVICE_TRANSACTION å‘½ä»¤ï¼ŒåŒæ—¶æ³¨å†ŒæœåŠ¡çš„çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ waitForResponse()ã€‚ Binder é©±åŠ¨æ”¶åˆ°è¯·æ±‚å‘½ä»¤å‘ ServiceManager çš„ todo é˜Ÿåˆ—é‡Œé¢æ·»åŠ ä¸€æ¡æ³¨å†ŒæœåŠ¡çš„äº‹åŠ¡ã€‚äº‹åŠ¡çš„ä»»åŠ¡å°±æ˜¯åˆ›å»ºæœåŠ¡ç«¯è¿›ç¨‹ binder_node ä¿¡æ¯å¹¶æ’å…¥åˆ° binder_procs é“¾è¡¨ä¸­ã€‚

- äº‹åŠ¡å¤„ç†å®Œä¹‹åå‘é€ BR_TRANSACTION å‘½ä»¤ï¼ŒServiceManager æ”¶åˆ°å‘½ä»¤åå‘ svcinfo åˆ—è¡¨ä¸­æ·»åŠ å·²ç»æ³¨å†Œçš„æœåŠ¡ã€‚æœ€åå‘é€ BR_REPLY å‘½ä»¤å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œé€šçŸ¥æ³¨å†ŒæˆåŠŸã€‚


## 7. ServiceManager è·å–æœåŠ¡

![å›¾6][6]

- è·å–æœåŠ¡çš„è¿‡ç¨‹ä¸æ³¨å†Œç±»ä¼¼ï¼Œç›¸åçš„è¿‡ç¨‹ã€‚é€šè¿‡ ServiceManager çš„ getService() æ–¹æ³•æ¥æ³¨å†ŒæœåŠ¡ã€‚

- é¦–å…ˆ ServiceManager å‘ Binder é©±åŠ¨å‘é€ BC_TRANSACTION å‘½ä»¤æºå¸¦ CHECK_SERVICE_TRANSACTION å‘½ä»¤ï¼ŒåŒæ—¶è·å–æœåŠ¡çš„çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ waitForResponse()ã€‚

- Binder é©±åŠ¨æ”¶åˆ°è¯·æ±‚å‘½ä»¤å‘ ServiceManager çš„å‘é€ BC_TRANSACTION æŸ¥è¯¢å·²æ³¨å†Œçš„æœåŠ¡ï¼ŒæŸ¥è¯¢åˆ°ç›´æ¥å“åº” BR_REPLY å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚è‹¥æŸ¥è¯¢ä¸åˆ°å°†ä¸ binder_procs é“¾è¡¨ä¸­çš„æœåŠ¡è¿›è¡Œä¸€æ¬¡é€šè®¯å†å“åº”ã€‚

## 8. è¿›è¡Œä¸€æ¬¡å®Œæ•´é€šè®¯

![å›¾7][7]

- æˆ‘ä»¬åœ¨ä½¿ç”¨ Binder æ—¶åŸºæœ¬éƒ½æ˜¯è°ƒç”¨ framework å±‚å°è£…å¥½çš„æ–¹æ³•ï¼ŒAIDL å°±æ˜¯ framework å±‚æä¾›çš„å‚»ç“œå¼æ˜¯ä½¿ç”¨æ–¹å¼ã€‚å‡è®¾æœåŠ¡å·²ç»æ³¨å†Œå®Œï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®¢æˆ·ç«¯æ€ä¹ˆæ‰§è¡ŒæœåŠ¡ç«¯çš„æ–¹æ³•ã€‚

- é¦–å…ˆæˆ‘ä»¬é€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡ç«¯çš„ BinderProxy ä»£ç†å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨ BinderProxy å°†å‚æ•°ï¼Œæ–¹æ³•æ ‡è¯†ï¼ˆä¾‹å¦‚ï¼šTRANSACTION_testï¼ŒAIDLä¸­è‡ªåŠ¨ç”Ÿæˆï¼‰ä¼ ç»™  ServiceManagerï¼ŒåŒæ—¶å®¢æˆ·ç«¯çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

- ServiceManager å°†ç”¨æˆ·ç©ºé—´çš„å‚æ•°ç­‰è¯·æ±‚æ•°æ®å¤åˆ¶åˆ°å†…æ ¸ç©ºé—´ï¼Œå¹¶å‘æœåŠ¡ç«¯æ’å…¥ä¸€æ¡æ‰§è¡Œæ‰§è¡Œæ–¹æ³•çš„äº‹åŠ¡ã€‚äº‹åŠ¡æ‰§è¡Œå®Œé€šçŸ¥ ServiceManager å°†æ‰§è¡Œç»“æœä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¹¶å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œå“åº”ç»“æœï¼Œé€šè®¯ç»“æŸã€‚

## æ€»ç»“
å¥½äº†ï¼Œè¿™é‡Œåªæ˜¯ä»å®ç°é€»è¾‘ä¸Šç®€å•ä»‹ç»äº†ä¸‹ Binder æœºåˆ¶çš„å·¥ä½œåŸç†ï¼Œæƒ³è¦æ·±å…¥ç†è§£ Binder æœºåˆ¶ï¼Œè¿˜å¾—è‡ªå·±ä¸‹åŠŸå¤«ï¼Œçœ‹æºç ï¼Œå°½ç®¡è¿™ä¸ªè¿‡ç¨‹å¾ˆç—›è‹¦ã€‚ä¸€éçœ‹ä¸æ‡‚å°±å†æ¥ä¸€éï¼Œè¯´å®è¯æœ¬äººç†è§£èƒ½åŠ›æ¯”è¾ƒå·®ï¼Œè·Ÿç€åšå®¢æ€è·¯çœ‹äº†ä¸ä¸‹åéã€‚ åŠªåŠ›æ€»ä¼šæœ‰æ”¶è·ï¼Œå¥½å¥½æ¬£èµ native å±‚å„æ–¹æ³•ä¹‹é—´èŠ±å¼è·³è½¬çš„é­…åŠ›å§ã€‚æœ€åä½ å°†å‘ç°æ–°ä¸–ç•Œçš„å¤§é—¨åœ¨å‘ä½ æ•å¼€ã€‚

ç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œä¸ªäººè§‰å¾—æ¯”è¾ƒå¥½çš„å¦‚ä¸‹ï¼š
1. [Banderè®¾è®¡ä¸å®ç°](http://blog.csdn.net/universus/article/details/6211589)
2. è€ç½—çš„ [Androidè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶Binderç®€è¦ä»‹ç»å’Œå­¦ä¹ è®¡åˆ’](http://blog.csdn.net/luoshengyang/article/details/6618363) ç³»åˆ—
3. Innostçš„ [æ·±å…¥ç†è§£Binder](http://blog.csdn.net/innost/article/details/47208049) ç³»åˆ—
4. Gityuançš„ [Binderç³»åˆ—](http://gityuan.com/2015/10/31/binder-prepare) (åŸºäº Android 6.0)
5. [Binderå­¦ä¹ æŒ‡å—](http://weishu.me/2016/01/12/binder-index-for-newer)

## å‚è€ƒèµ„æ–™

- [Binderç³»åˆ—](http://gityuan.com/2015/10/31/binder-prepare)
- [Binderå­¦ä¹ æŒ‡å—](http://weishu.me/2016/01/12/binder-index-for-newer)

[1]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/binder_main.jpg
[2]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/binder_device.jpg
[3]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/process_thread.jpg
[4]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/service_manager_start.jpg
[5]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/service_manager_add.jpg
[6]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/service_manager_get.jpg
[7]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/binder_one_main.jpg
[8]:https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/android/android_binder/binder_main_request.jpg



## æˆ‘çš„å…¬ä¼—å·

æ¬¢è¿ä½ ã€Œæ‰«ä¸€æ‰«ã€ä¸‹é¢çš„äºŒç»´ç ï¼Œå…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œå¯ä»¥æ¥å—æœ€æ–°çš„æ–‡ç« æ¨é€ï¼Œæœ‰ä¸°åšçš„æŠ½å¥–æ´»åŠ¨å’Œç¦åˆ©ç­‰ç€ä½ å“¦ï¼ğŸ˜

<img src="https://raw.githubusercontent.com/jeanboydev/Android-ReadTheFuckingSourceCode/master/resources/images/about_me/qrcode_android_besos_black_512.png" width=250 height=250 />

å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®æˆ–è€…é—®é¢˜ï¼Œå¯ä»¥ [ç‚¹å‡»è¿™é‡Œ](https://github.com/jeanboydev/Android-ReadTheFuckingSourceCode/issues) æäº¤ issueï¼Œä¹Ÿå¯ä»¥å‘é‚®ä»¶ç»™æˆ‘ [jeanboy@foxmail.com](mailto:jeanboy@foxmail.com)ã€‚

åŒæ—¶æ¬¢è¿ä½  [![AndroidæŠ€æœ¯è¿›é˜¶ï¼š386463747](https://camo.githubusercontent.com/615c9901677f501582b6057efc9396b3ed27dc29/687474703a2f2f7075622e69647171696d672e636f6d2f7770612f696d616765732f67726f75702e706e67)](http://shang.qq.com/wpa/qunwpa?idkey=0b505511df9ead28ec678df4eeb7a1a8f994ea8b75f2c10412b57e667d81b50d) æ¥ä¸€èµ·äº¤æµå­¦ä¹ ï¼Œç¾¤é‡Œæœ‰å¾ˆå¤šå¤§ç‰›å’Œå­¦ä¹ èµ„æ–™ï¼Œç›¸ä¿¡ä¸€å®šèƒ½å¸®åŠ©åˆ°ä½ ï¼

